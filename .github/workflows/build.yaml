#===============================================================================
# Build pipeline for pull requests
#===============================================================================
name: build

on:
  push:
    branches:
    - main
  pull_request:

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“š Checkout (GitHub)
      uses: actions/checkout@v4
  
    - name: ðŸ› ï¸ Install build dependencies (Go 1.22)
      uses: actions/setup-go@v5
      with:
        go-version: "1.22"
        cache: false

    - name: ðŸ› ï¸ Install build dependencies (Go packages)
      run: |
        go install gotest.tools/gotestsum@latest
        go install github.com/goreleaser/goreleaser/v2@latest

    - name: ðŸ‘· Check formatting
      run: |
        STATUS=0
        assert-nothing-changed() {
          local diff
          "$@" >/dev/null || return 1
          if ! diff="$(git diff -U1 --color --exit-code)"; then
            printf '\e[31mError: running `\e[1m%s\e[22m` results in modifications that you must check into version control:\e[0m\n%s\n\n' "$*" "$diff" >&2
            git checkout -- .
            STATUS=1
          fi
        }

        assert-nothing-changed go fmt ./...
        assert-nothing-changed go mod tidy

        exit $STATUS

    - name: ðŸ‘· Run linter to verify codebase (ci-lint 1.58.1)
      uses: golangci/golangci-lint-action@v6
      with:
        version: v1.58.1
        skip-cache: true
        skip-pkg-cache: true
        skip-build-cache: true

    - name: ðŸ‘· Build
      run: make build

    - name: ðŸ“š Run tests
      run: make test

    - name: ghcr-login
      if: startsWith(github.ref, 'refs/tags/v')
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¦ Test release packaging
      run: goreleaser --snapshot --clean